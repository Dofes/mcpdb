# MCPDB - Minecraft China Bedrock Python Debugger

[![Build Status](https://img.shields.io/badge/build-passing-brightgreen.svg)]()
[![Platform](https://img.shields.io/badge/platform-Windows%20x64-blue.svg)]()
[![Language](https://img.shields.io/badge/language-C++20-orange.svg)]()
[![License](https://img.shields.io/badge/license-MIT-green.svg)]()

## ğŸ“– é¡¹ç›®ç®€ä»‹

**MCPDB** (Minecraft China Python Debugger Backend) æ˜¯ä¸€ä¸ªä¸“ä¸º **æˆ‘çš„ä¸–ç•Œä¸­å›½ç‰ˆåŸºå²©ç‰ˆ** è®¾è®¡çš„ Python è°ƒè¯•å™¨åç«¯ã€‚å®ƒå®ç°äº† [Debug Adapter Protocol (DAP)](https://microsoft.github.io/debug-adapter-protocol/) åè®®ï¼Œä½¿å¼€å‘è€…èƒ½å¤Ÿä½¿ç”¨ VS Code ç­‰ç°ä»£ IDE å¯¹æ¸¸æˆå†…çš„ Python è„šæœ¬è¿›è¡Œå®æ—¶è°ƒè¯•ã€‚

ç”±äºä¸­å›½ç‰ˆå¹¶æœªå¯¼å‡º Python APIï¼Œæœ¬é¡¹ç›®é€šè¿‡ä¸€äº›å†…å­˜æŠ€æœ¯æ¥å®ç°å¯¹æ¸¸æˆå†…åµŒ Python è§£é‡Šå™¨çš„è®¿é—®å’Œæ§åˆ¶ã€‚

## ğŸ¯ åº”ç”¨åœºæ™¯

- **Mod/æ’ä»¶å¼€å‘è°ƒè¯•**ï¼šåœ¨æ¸¸æˆè¿è¡Œæ—¶å¯¹ Python è„šæœ¬è®¾ç½®æ–­ç‚¹ã€å•æ­¥æ‰§è¡Œ
- **å˜é‡æ£€æŸ¥**ï¼šå®æ—¶æŸ¥çœ‹å’Œä¿®æ”¹ Python å˜é‡çš„å€¼
- **è°ƒç”¨æ ˆåˆ†æ**ï¼šè¿½è¸ªå‡½æ•°è°ƒç”¨é“¾ï¼Œå®šä½é—®é¢˜æ ¹æº
- **è¡¨è¾¾å¼æ±‚å€¼**ï¼šåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­æ‰§è¡Œä»»æ„ Python è¡¨è¾¾å¼

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VS Code / IDE                           â”‚
â”‚                    (DAP Client - debugpy)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ TCP
                              â”‚ DAP Protocol (JSON)
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       MCPDB (bedrock.dll)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    DAP Debugger Core                    â”‚    â”‚
â”‚  â”‚  â€¢ æ–­ç‚¹ç®¡ç† (Breakpoint Management)                       â”‚    â”‚
â”‚  â”‚  â€¢ å †æ ˆå¸§ç®¡ç† (Stack Frame Management)                    â”‚    â”‚
â”‚  â”‚  â€¢ å˜é‡æ£€æŸ¥ (Variable Inspection)                         â”‚    â”‚
â”‚  â”‚  â€¢ å•æ­¥æ‰§è¡Œ (Step Over/Into/Out)                          â”‚    â”‚
â”‚  â”‚  â€¢ è¡¨è¾¾å¼æ±‚å€¼ (Expression Evaluation)                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Python Wrapper                       â”‚    â”‚
â”‚  â”‚  â€¢ ä¸é€æ˜å¥æŸ„å°è£… (Opaque Handle Abstraction)              â”‚    â”‚
â”‚  â”‚  â€¢ ç±»å‹å®‰å…¨è®¿é—® (Type-Safe Access)                         â”‚    â”‚
â”‚  â”‚  â€¢ å¼•ç”¨è®¡æ•°ç®¡ç† (Reference Count Management)               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Memory API Layer                     â”‚    â”‚
â”‚  â”‚  â€¢ ç‰¹å¾ç æ‰«æ (Signature Scanning)                        â”‚    â”‚
â”‚  â”‚  â€¢ å‡½æ•° Hook (Function Hooking)                          â”‚    â”‚
â”‚  â”‚  â€¢ å†…å­˜è¡¥ä¸ (Memory Patching)                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ Function Hooks
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Minecraft China Bedrock Edition                    â”‚
â”‚                  (Embedded Python 2.7 Interpreter)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. ç‰¹å¾ç æ‰«æ (Signature Scanning)

ç”±äºæ¸¸æˆä¸å¯¼å‡º Python API ç¬¦å·ï¼Œæˆ‘ä»¬é€šè¿‡ç‰¹å¾ç æ‰«æåœ¨å†…å­˜ä¸­å®šä½æ‰€éœ€çš„å‡½æ•°åœ°å€ï¼š

```cpp
// ç¤ºä¾‹ï¼šå®šä½ PyObject_GetAttrString å‡½æ•°
static auto funcptr = memory::resolveSignature(
    "..."
);
```

### 2. å‡½æ•° Hook (Function Hooking)

é€šè¿‡ Hook Python è§£é‡Šå™¨çš„æ ¸å¿ƒæ‰§è¡Œå‡½æ•° `PyEval_EvalFrameEx`ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨æ¯è¡Œä»£ç æ‰§è¡Œæ—¶è·å¾—æ§åˆ¶æƒï¼š

```cpp
// Hook Python å­—èŠ‚ç æ‰§è¡Œå¾ªç¯ä¸­çš„ opcode åˆ†å‘ç‚¹
void InstallBreakpointHook() {
    auto addr = memory::resolveSignature(
        "..."
    );
    // å®‰è£…è·³è½¬åˆ°æˆ‘ä»¬çš„å¤„ç†å‡½æ•°
}
```

### 3. Python API åŒ…è£…å±‚

ä¸ºäº†å®‰å…¨åœ°ä¸ Python è§£é‡Šå™¨äº¤äº’ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€å¥—ä¸é€æ˜å¥æŸ„ç³»ç»Ÿï¼š

```cpp
using PyHandle = void*;           // ä¸é€æ˜ Python å¯¹è±¡å¥æŸ„
using PyFrameHandle = void*;      // å¸§å¯¹è±¡å¥æŸ„
using PyCodeHandle = void*;       // ä»£ç å¯¹è±¡å¥æŸ„

// RAII åŒ…è£…å™¨è‡ªåŠ¨ç®¡ç†å¼•ç”¨è®¡æ•°
class ObjectGuard {
    PyHandle obj_;
public:
    ~ObjectGuard() { py::xdecref(obj_); }
};
```

### 4. DAP åè®®å®ç°

å®ç°å®Œæ•´çš„ Debug Adapter Protocolï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š

| åŠŸèƒ½     | DAP è¯·æ±‚                                | æè¿°              |
| -------- | --------------------------------------- | ----------------- |
| åˆå§‹åŒ–   | `initialize`                            | å»ºç«‹è°ƒè¯•ä¼šè¯      |
| æ–­ç‚¹     | `setBreakpoints`                        | è®¾ç½®/æ¸…é™¤æ–­ç‚¹     |
| æ‰§è¡Œæ§åˆ¶ | `continue`, `next`, `stepIn`, `stepOut` | æµç¨‹æ§åˆ¶          |
| è°ƒç”¨æ ˆ   | `stackTrace`                            | è·å–å½“å‰è°ƒç”¨æ ˆ    |
| å˜é‡     | `scopes`, `variables`                   | æŸ¥çœ‹å±€éƒ¨/å…¨å±€å˜é‡ |
| æ±‚å€¼     | `evaluate`                              | æ‰§è¡Œè¡¨è¾¾å¼        |

## ğŸ“ é¡¹ç›®ç»“æ„

```
mcpdb/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ debugger.cpp/h          # DAP è°ƒè¯•å™¨æ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ dllmain.cpp             # DLL å…¥å£ç‚¹
â”‚   â”œâ”€â”€ py_wrapper.cpp/h        # Python API å®‰å…¨å°è£…
â”‚   â”œâ”€â”€ py_func_hook.cpp        # Python å‡½æ•° Hook å®ç°
â”‚   â”œâ”€â”€ py_eval_hook.cpp        # å­—èŠ‚ç æ‰§è¡Œ Hook
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ memory/
â”‚   â”‚   â”‚   â”œâ”€â”€ Hook.cpp/h      # å‡½æ•° Hook æ¡†æ¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Memory.cpp/h    # å†…å­˜æ“ä½œã€ç‰¹å¾ç æ‰«æ
â”‚   â”‚   â”‚   â””â”€â”€ Patch.cpp/h     # å†…å­˜è¡¥ä¸
â”‚   â”‚   â”œâ”€â”€ Logger.hpp          # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ Utils.cpp/h         # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ py/                     # Python 2.7 å¤´æ–‡ä»¶
â”œâ”€â”€ src-injector/
â”‚   â””â”€â”€ main.cpp                # DLL æ³¨å…¥å™¨
â”œâ”€â”€ xmake.lua                   # æ„å»ºé…ç½®
â””â”€â”€ README.md
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ„å»ºè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Windows 10/11 x64
- **ç¼–è¯‘å™¨**: MSVC (Visual Studio 2022+)
- **æ„å»ºå·¥å…·**: [xmake](https://xmake.io/)
- **C++ æ ‡å‡†**: C++20

### ç¼–è¯‘æ­¥éª¤

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/Dofes/mcpdb.git
cd mcpdb

# å®‰è£…ä¾èµ–å¹¶ç¼–è¯‘
xmake

# ç¼–è¯‘äº§ç‰©
# - build/windows/x64/release/bedrock.dll (è°ƒè¯•å™¨ DLL)
# - build/windows/x64/release/bedrock-injector.exe (æ³¨å…¥å™¨)
```

### ä½¿ç”¨æ–¹æ³•

1. **å¯åŠ¨æˆ‘çš„ä¸–ç•Œä¸­å›½ç‰ˆåŸºå²©ç‰ˆ**

2. **è¿è¡Œæ³¨å…¥å™¨**ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

   ```bash
   bedrock-injector.exe
   ```

3. **é…ç½® VS Code launch.json**

   ```json
   {
     "version": "0.2.0",
     "configurations": [
       {
         "name": "Attach to Minecraft",
         "type": "python",
         "request": "attach",
         "connect": {
           "host": "127.0.0.1",
           "port": 5678
         },
         "pathMappings": [
           {
             "localRoot": "${workspaceFolder}/scripts",
             "remoteRoot": "."
           }
         ]
       }
     ]
   }
   ```

4. **å¼€å§‹è°ƒè¯•**
   - åœ¨ VS Code ä¸­æ‰“å¼€ä½ çš„ Python è„šæœ¬
   - è®¾ç½®æ–­ç‚¹
   - æŒ‰ F5 é™„åŠ åˆ°æ¸¸æˆè¿›ç¨‹
   - è§¦å‘è„šæœ¬æ‰§è¡Œï¼Œæ–­ç‚¹å‘½ä¸­åå³å¯è°ƒè¯•

### å¸è½½ Hook

åœ¨æ¸¸æˆè¿è¡Œæ—¶æŒ‰ä¸‹ **End** é”®å¯ä»¥å®‰å…¨å¸è½½è°ƒè¯•å™¨ DLLã€‚

## ğŸ“¦ ä¾èµ–é¡¹

| åº“                                                                     | ç‰ˆæœ¬    | ç”¨é€”                  |
| ---------------------------------------------------------------------- | ------- | --------------------- |
| [nlohmann_json](https://github.com/nlohmann/json)                      | v3.11.3 | JSON è§£æï¼ˆDAP åè®®ï¼‰ |
| [fmt](https://github.com/fmtlib/fmt)                                   | 10.2.1  | æ ¼å¼åŒ–è¾“å‡º            |
| [detours](https://github.com/microsoft/Detours)                        | v4.0.1  | å‡½æ•° Hook             |
| [minhook](https://github.com/TsudaKageworthy/minhook)                  | v1.3.3  | è½»é‡çº§ Hook åº“        |
| [ctre](https://github.com/hanickadot/compile-time-regular-expressions) | 3.8.1   | ç¼–è¯‘æœŸæ­£åˆ™è¡¨è¾¾å¼      |
| [magic_enum](https://github.com/Neargye/magic_enum)                    | v0.9.7  | æšä¸¾åå°„              |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä»…ä¾›å­¦ä¹ ç ”ç©¶ä½¿ç”¨**ï¼šæœ¬é¡¹ç›®ä»…ç”¨äºæ¸¸æˆ Mod å¼€å‘å’Œè°ƒè¯•ç›®çš„
2. **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šç‰¹å¾ç å¯èƒ½éšæ¸¸æˆæ›´æ–°è€Œå¤±æ•ˆï¼Œéœ€è¦é‡æ–°å®šä½
3. **ç¨³å®šæ€§**ï¼šå†…å­˜æ“ä½œå…·æœ‰ä¸€å®šé£é™©ï¼Œå»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä½¿ç”¨
4. **ç®¡ç†å‘˜æƒé™**ï¼šDLL æ³¨å…¥éœ€è¦ç®¡ç†å‘˜æƒé™è¿è¡Œ

## ğŸ” è°ƒè¯•æŠ€å·§

### è·¯å¾„æ˜ å°„

è°ƒè¯•å™¨æ”¯æŒ Python æ¨¡å—è·¯å¾„åˆ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„çš„è‡ªåŠ¨æ˜ å°„ï¼š

```
æ¨¡å—è·¯å¾„: ark_scripts.system.entity_rank.entityRankServer
æ–‡ä»¶è·¯å¾„: c:/project/beh/ark_scripts/system/entity_rank/entityRankServer.py
```

### æ¡ä»¶æ–­ç‚¹

æ”¯æŒè®¾ç½®æ¡ä»¶æ–­ç‚¹ï¼Œä»…åœ¨æ¡ä»¶ä¸ºçœŸæ—¶è§¦å‘ï¼š

```python
# ä»…å½“ player_id == 123 æ—¶è§¦å‘æ–­ç‚¹
```

## ğŸ“„ License

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

**Made with â¤ï¸ for Minecraft China modders**
